name: NPM Token Expiration Reminder

on:
  schedule:
    # Executa 1x por mês (dia 1 às 09:00 UTC)
    - cron: "0 9 1 * *"
  workflow_dispatch:

jobs:
  check-npm-token:
    runs-on: ubuntu-latest

    steps:
      - name: Check NPM token expiration and create reminder
        uses: actions/github-script@v7
        env:
          NPM_TOKEN_EXPIRES_AT: ${{ secrets.NPM_TOKEN_EXPIRES_AT }}
        with:
          script: |
            const DAYS_BEFORE_EXPIRATION = 14

            const expiresAt = process.env.NPM_TOKEN_EXPIRES_AT

            if (!expiresAt) {
              core.warning("Secret NPM_TOKEN_EXPIRES_AT não definido.")
              return
            }

            const expirationDate = new Date(expiresAt)
            const now = new Date()

            const diffTime = expirationDate - now
            const daysLeft = Math.ceil(diffTime / (1000 * 60 * 60 * 24))

            if (daysLeft > DAYS_BEFORE_EXPIRATION) {
              console.log(`Token válido por mais ${daysLeft} dias. Nenhuma ação necessária.`)
              return
            }

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open",
              labels: "npm-token"
            })

            if (issues.length > 0) {
              console.log("Já existe um lembrete aberto.")
              return
            }

            const body = `
### ⚠️ Action required: NPM Token expiring

The **NPM_TOKEN** used for automated publishing will expire in **${daysLeft} days**.

#### What to do
1. Create a new **Granular Access Token** on npm
   - Permission: **Read & Write**
   - Scope: **@henriquepetrelli**
   - Expiration: **90 days**
   - Enable **2FA bypass**
2. Update the \`NPM_TOKEN\` secret in **GitHub Actions**
3. Update the \`NPM_TOKEN_EXPIRES_AT\` secret with the new expiration date
4. Revoke the old token

⚠️ If this is not done, automated publishing will fail.
`

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "⚠️ NPM token expiring",
              body,
              labels: ["npm-token", "automation"]
            })
