name: NPM Token Expiration Reminder

on:
  schedule:
    # Executa 1x por mês (dia 1 às 09:00 UTC)
    - cron: '0 9 1 * *'
  workflow_dispatch:

jobs:
  reminder:
    runs-on: ubuntu-latest

    steps:
      - name: Check NPM token expiration and create issue
        uses: actions/github-script@v7
        with:
          script: |
            const DAYS_BEFORE_EXPIRATION = 14

            const expiresAt = process.env.NPM_TOKEN_EXPIRES_AT
            if (!expiresAt) {
              core.warning("NPM_TOKEN_EXPIRES_AT secret not set")
              return
            }

            const expirationDate = new Date(expiresAt)
            const now = new Date()
            const daysLeft = Math.ceil(
              (expirationDate - now) / (1000 * 60 * 60 * 24)
            )

            if (daysLeft > DAYS_BEFORE_EXPIRATION) {
              console.log(`Token valid for ${daysLeft} more days`)
              return
            }

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open",
              labels: "npm-token"
            })

            if (issues.length > 0) {
              console.log("Reminder already exists")
              return
            }

            const body = [
              "### ⚠️ Action required: NPM Token expiring",
              "",
              `The **NPM_TOKEN** used for automated publishing will expire in **${daysLeft} days**.`,
              "",
              "#### Steps",
              "1. Create a new **Granular Access Token** on npm",
              "   - Permission: **Read & Write**",
              "   - Scope: **@henriquepetrelli**",
              "   - Expiration: **90 days**",
              "   - **2FA bypass enabled**",
              "2. Update the `NPM_TOKEN` secret in **GitHub Actions**",
              "3. Update the `NPM_TOKEN_EXPIRES_AT` secret",
              "4. Revoke the old token",
              "",
              "⚠️ If this is not done, automated publishing will fail."
            ].join("\n")

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "⚠️ Rotate NPM_TOKEN (CI publish)",
              body,
              labels: ["npm-token", "automation"]
            })
        env:
          NPM_TOKEN_EXPIRES_AT: ${{ secrets.NPM_TOKEN_EXPIRES_AT }}
